.. note::

    ã“ã‚“ã«ã¡ã¯ã€SunFounderã®Raspberry Pi & Arduino & ESP32æ„›å¥½å®¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ãï¼Facebookä¸Šã§Raspberry Piã€Arduinoã€ESP32ã«ã¤ã„ã¦ã‚‚ã£ã¨æ·±ãæ˜ã‚Šä¸‹ã’ã€ä»–ã®æ„›å¥½å®¶ã¨äº¤æµã—ã¾ã—ã‚‡ã†ã€‚

    **å‚åŠ ã™ã‚‹ç†ç”±ã¯ï¼Ÿ**

    - **ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã‚µãƒãƒ¼ãƒˆ**ï¼šã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„ãƒãƒ¼ãƒ ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€è²©å£²å¾Œã®å•é¡Œã‚„æŠ€è¡“çš„ãªèª²é¡Œã‚’è§£æ±ºã—ã¾ã™ã€‚
    - **å­¦ã³ï¼†å…±æœ‰**ï¼šãƒ’ãƒ³ãƒˆã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’äº¤æ›ã—ã¦ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚
    - **ç‹¬å çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**ï¼šæ–°è£½å“ã®ç™ºè¡¨ã‚„å…ˆè¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ—©æœŸã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚
    - **ç‰¹åˆ¥å‰²å¼•**ï¼šæœ€æ–°è£½å“ã®ç‹¬å å‰²å¼•ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
    - **ç¥­ã‚Šã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚®ãƒ•ãƒˆ**ï¼šã‚®ãƒ•ãƒˆã‚„ç¥æ—¥ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ã€‚

    ğŸ‘‰ ç§ãŸã¡ã¨ä¸€ç·’ã«æ¢ç´¢ã—ã€å‰µé€ ã™ã‚‹æº–å‚™ã¯ã§ãã¦ã„ã¾ã™ã‹ï¼Ÿ[|link_sf_facebook|]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»Šã™ãå‚åŠ ã—ã¾ã—ã‚‡ã†ï¼

4. @OpenWeatherMapã‹ã‚‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¤©æ°—æƒ…å ±
===============================================

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€LCDã«æ™‚é–“ã¨ä¸€ç·’ã«ç¾åœ¨ã®å¤©æ°—ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ãƒãƒ¼ãƒˆã‚¯ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

**1. å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚

ä¸€å¼ã‚’ã¾ã¨ã‚ã¦è³¼å…¥ã™ã‚‹ã®ãŒä¾¿åˆ©ã§ã™ã€‚ãƒªãƒ³ã‚¯ã¯ã“ã¡ã‚‰ï¼š

.. list-table::
    :widths: 20 20 20
    :header-rows: 1

    *   - åç§°
        - ã“ã®ã‚­ãƒƒãƒˆã«å«ã¾ã‚Œã‚‹ã‚¢ã‚¤ãƒ†ãƒ æ•°
        - ãƒªãƒ³ã‚¯
    *   - ã‚±ãƒ—ãƒ©ãƒ¼ã‚­ãƒƒãƒˆ
        - 450+
        - |link_kepler_kit|

ä¸‹è¨˜ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å€‹åˆ¥ã«ã‚‚è³¼å…¥å¯èƒ½ã§ã™ã€‚

.. list-table::
    :widths: 5 20 5 20
    :header-rows: 1

    *   - SN
        - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        - å€‹æ•°
        - ãƒªãƒ³ã‚¯

    *   - 1
        - :ref:`cpn_pico_w`
        - 1
        - |link_picow_buy|
    *   - 2
        - Micro USBã‚±ãƒ¼ãƒ–ãƒ«
        - 1
        - 
    *   - 3
        - :ref:`cpn_breadboard`
        - 1
        - |link_breadboard_buy|
    *   - 4
        - :ref:`cpn_wire`
        - æ•°æœ¬
        - |link_wires_buy|
    *   - 5
        - :ref:`cpn_i2c_lcd`
        - 1
        - |link_i2clcd1602_buy|
    *   - 6
        - :ref:`cpn_lipo_charger`
        - 1
        -  
    *   - 7
        - 18650ãƒãƒƒãƒ†ãƒªãƒ¼
        - 1
        -  
    *   - 8
        - ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼
        - 1
        -  

**2. å›è·¯ã‚’ä½œæˆã™ã‚‹**

    .. warning::

        Li-poå……é›»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå›³ã®é€šã‚Šã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã€ã‚·ãƒ§ãƒ¼ãƒˆãŒèµ·ãã¦ãƒãƒƒãƒ†ãƒªãƒ¼ã‚„å›è·¯ãŒæå‚·ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

.. image:: img/wiring/4.owm_bb.png

**3. OpenWeatherã®APIã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹**

|link_openweather| ã¯ã€OpenWeather LtdãŒé‹å–¶ã™ã‚‹ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã§ã€APIã‚’ä»‹ã—ã¦å…¨ä¸–ç•Œã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ç¾åœ¨ã®å¤©æ°—ã€äºˆå ±ã€çŸ­æœŸäºˆå ±ã€éå»ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãªã©ã€åœ°ç†çš„ãªä½ç½®ã«é–¢ä¿‚ãªãå–å¾—ã§ãã¾ã™ã€‚

#. |link_openweather| ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ï¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

    .. image:: img/OWM-1.png

#. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‹ã‚‰APIãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚

    .. image:: img/OWM-2.png

#. **ç¾åœ¨ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿** ã‚’è¦‹ã¤ã‘ã¦ã€ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

    .. image:: img/OWM-3.png

#. **ç¾åœ¨ã®å¤©æ°—ã¨äºˆå ±ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³** ã®ä¸‹ã§ã€é©åˆ‡ãªã‚µãƒ¼ãƒ“ã‚¹ã«ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ååˆ†ã§ã™ã€‚

   .. image:: img/OWM-4.png

#. **APIã‚­ãƒ¼** ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

   .. image:: img/OWM-5.png
 
#. ãã‚Œã‚’Raspberry Pi Pico Wã® ``secrets.py`` ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

    .. image:: img/4_openweather1.png

    .. note::

        ã‚‚ã—Pico Wã« ``do_connect.py`` ãŠã‚ˆã³ ``secrets.py`` ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãªã„å ´åˆã€ :ref:`iot_access` ã‚’å‚ç…§ã—ã¦ä½œæˆã—ã¦ãã ã•ã„ã€‚

    .. code-block:: python
        :emphasize-lines: 5

        secrets = {
        'ssid': 'SSID',
        'password': 'PASSWORD',
        'webhooks_key':'WEBHOOKS_API_KEY',
        'openweather_api_key':'OPENWEATHERMAP_API_KEY'
        }

**4. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹**

#. ``kepler-kit-main/iot`` ãƒ‘ã‚¹ã®ä¸‹ã«ã‚ã‚‹ ``4_weather.py`` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã€ **ç¾åœ¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€F5ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

    .. image:: img/4_openweather2.png

#. ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚ŒãŸå¾Œã€I2C LCD1602ã«ã‚ãªãŸã®åœ°åŸŸã®æ™‚é–“ã¨å¤©æ°—æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

    .. note::

        ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œä¸­ã§ç”»é¢ãŒçœŸã£ç™½ãªå ´åˆã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èƒŒé¢ã«ã‚ã‚‹ãƒãƒ†ãƒ³ã‚·ãƒ§ãƒ¡ãƒ¼ã‚¿ã‚’å›ã—ã¦ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’èª¿æ•´ã§ãã¾ã™ã€‚

#. ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èµ·å‹•æ™‚ã«è‡ªå‹•çš„ã«å®Ÿè¡Œã•ã›ãŸã„å ´åˆã¯ã€ãã‚Œã‚’Raspberry Pi Pico Wã« ``main.py`` ã¨ã—ã¦ä¿å­˜ã§ãã¾ã™ã€‚


**å‹•ä½œåŸç†ã¯ï¼Ÿ**

Raspberry Pi Pico Wã¯ã€ :ref:`iot_access` ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚

.. code-block:: python

    from do_connect import *
    do_connect()

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã—ãŸå¾Œã€ä»¥ä¸‹ã®æ•°è¡Œã®ã‚³ãƒ¼ãƒ‰ã§Pico Wã®æ™‚åˆ»ã‚’ã‚°ãƒªãƒ‹ãƒƒã‚¸æ¨™æº–æ™‚ã«åŒæœŸã—ã¾ã™ã€‚

.. code-block:: python

   import ntptime
   while True:
      try:
         ntptime.settime()
         print('Time Set Successfully')
         break
      except OSError:
         print('Time Setting...')
         continue    

LCDã‚’åˆæœŸåŒ–ã™ã‚‹ã«ã¯ã€ :ref:`py_lcd` ã‚’å‚ç…§ã—ã¦ã€ä½¿ç”¨æ–¹æ³•ã®è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

.. code-block:: python

   from lcd1602 import LCD
   lcd=LCD()
   lcd.clear() 
   string = 'Loading...'
   lcd.message(string)

å¤©æ°—ãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹ï¼šæ°—æ¸©ã€é¢¨é€Ÿï¼‰ã‚’å–å¾—ã™ã‚‹å‰ã«ã€å˜ä½ã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€å˜ä½ã¯ ``metric`` ã§ã™ã€‚

.. code-block:: python

   # Open Weather
   TEMPERATURE_UNITS = {
      "standard": "K",
      "metric": "Â°C",
      "imperial": "Â°F",
   }

   SPEED_UNITS = {
      "standard": "m/s",
      "metric": "m/s",
      "imperial": "mph",
   }

   units = "metric"

æ¬¡ã«ã€ã“ã®é–¢æ•°ã¯ ``openweathermap.org`` ã‹ã‚‰å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
éƒ½å¸‚åã€APIã‚­ãƒ¼ã€è¨­å®šã•ã‚ŒãŸå˜ä½ã§URLãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚
çµæœã¨ã—ã¦ã€å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã‚‹ ``JSON`` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

.. code-block:: python

   def get_weather(city, api_key, units='metric', lang='en'):
      '''
      Get weather data from openweathermap.org
         city: City name, state code and country code divided by comma, Please, refer to ISO 3166 for the state codes or country codes. https://www.iso.org/obp/ui/#search
         api_key: Your unique API key (you can always find it on your openweather account page under the "API key" tab https://home.openweathermap.org/api_keys)
         unit: Units of measurement. standard, metric and imperial units are available. If you do not use the units parameter, standard units will be applied by default. More: https://openweathermap.org/current#data
         lang: You can use this parameter to get the output in your language. More: https://openweathermap.org/current#multi
      '''
      url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}&units={units}&lang={lang}"
      print(url)
      res = urequests.post(url)
      return res.json()

ã“ã®ä¸€é€£ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹ã¨ã€ä»¥ä¸‹ã«ç¤ºã™ã‚ˆã†ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

.. code-block:: python

   weather data example:
   {
       'timezone': 28800,
       'sys': {
           'type': 2,
           'sunrise': 1659650200,
           'country': 'CN',
           'id': 2031340,
           'sunset': 1659697371
       },
       'base': 'stations',
       'main': {
           'pressure': 1008,
           'feels_like': 304.73,
           'temp_max': 301.01,
           'temp': 300.4,
           'temp_min': 299.38,
           'humidity': 91,
           'sea_level': 1008,
           'grnd_level': 1006
       },
       'visibility': 10000,
       'id': 1795565,
       'clouds': {
           'all': 96
       }, 
       'coord': {
           'lon': 114.0683,
           'lat': 22.5455
       },
       'name': 'Shenzhen',
       'cod': 200,
       'weather':[{
           'id': 804,
           'icon': '04d',
           'main': 'Clouds',
           'description': 'overcast clouds'
       }],
       'dt': 1659663579,
       'wind': {
           'gust': 7.06,
           'speed': 3.69,
           'deg': 146
       }
   }

``print_weather(weather_data)`` é–¢æ•°ã‚’ä½¿ã£ã¦ã€ã“ã‚Œã‚‰ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«å¤‰æ›ã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
ã“ã®é–¢æ•°ã¯å‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ ``while True`` å†…ã§å¿…è¦ã«å¿œã˜ã¦ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ã§ãã¾ã™ã€‚

.. image:: img/4_openweather3.png

.. code-block:: python
   :emphasize-lines: 2

   # ã‚·ã‚§ãƒ«å‡ºåŠ›
   print_weather(weather_data)

``while True`` ãƒ«ãƒ¼ãƒ—ã§ã¯ã€æœ€åˆã« ``get_weather()`` é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿…è¦ãª ``weather`` ã€ ``temperature`` ã€ ``humidity`` æƒ…å ±ãŒå–å¾—ã•ã‚Œã¾ã™ã€‚

.. code-block:: python

   weather_data = get_weather('shenzhen', secrets['openweather_api_key'], units=units)
   weather=weather_data["weather"][0]["main"]
   t=weather_data["main"]["temp"]
   rh=weather_data["main"]["humidity"]

ç¾åœ°æ™‚é–“ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã“ã§ã¯ ``time.localtime()`` é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã€ã‚¿ãƒ—ãƒ«ï¼ˆå¹´ã€æœˆã€æ—¥ã€æ™‚é–“ã€åˆ†ã€ç§’ã€æ›œæ—¥ã€å¹´æ—¥ï¼‰ã®ã‚»ãƒƒãƒˆãŒè¿”ã•ã‚Œã¾ã™ã€‚ã“ã®ä¸­ã‹ã‚‰ ``hour`` ã¨ ``minute`` ã‚’å–ã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚

ã™ã§ã«Pico Wã¯ã‚°ãƒªãƒ‹ãƒƒã‚¸æ¨™æº–æ™‚ã«åŒæœŸã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚ãªãŸã®åœ°åŸŸã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

.. code-block:: python
    
    # æ™‚é–“ã®å–å¾—ï¼ˆ+24ã¯è¥¿åŠçƒç”¨ï¼‰
    # è² ã®å ´åˆã¯24ã‚’åŠ ãˆã‚‹
    # hours = time.localtime()[3] + int(weather_data["timezone"] / 3600) + 24  # è¥¿åŠçƒã®ã¿

    hours = time.localtime()[3] + int(weather_data["timezone"] / 3600)
    mins = time.localtime()[4]

æœ€çµ‚çš„ã«ã€å¤©æ°—æƒ…å ±ã¨æ™‚åˆ»ã¯LCD1602ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

.. code-block:: python

   lcd.clear()
   time.sleep_ms(200)
   string = f'{hours:02d}:{mins:02d} {weather}\n'
   lcd.message(string)
   string = f'{t}{TEMPERATURE_UNITS[units]} {rh}%rh'
   lcd.message(string)

ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ãŒ30ç§’ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€LCD1602ã¯30ç§’ã”ã¨ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹æ™‚è¨ˆã«ãªã‚Šã¾ã™ã€‚

